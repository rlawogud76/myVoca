<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ì–´ ë‹¨ì–´ í•™ìŠµ</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 10px; }
        .container { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 700px; width: 100%; max-height: 95vh; overflow-y: auto; }
        .hidden { display: none !important; }
        .btn { padding: 12px 24px; font-size: 15px; border: none; border-radius: 10px; cursor: pointer; background: linear-gradient(135deg, #667eea, #764ba2); color: white; transition: all 0.2s; margin: 5px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: linear-gradient(135deg, #ff9800, #f57c00); }
        .btn-small { padding: 8px 16px; font-size: 13px; }
        .start-section { text-align: center; padding: 10px; }
        .start-section h1 { font-size: 24px; margin-bottom: 12px; color: #333; }
        .start-section p { color: #666; margin-bottom: 15px; font-size: 14px; }
        .wordlist-selector { margin: 15px 0; }
        .wordlist-selector select { padding: 10px 15px; font-size: 14px; border: 2px solid #e0e0e0; border-radius: 10px; width: 100%; max-width: 300px; }
        .mode-buttons { display: flex; flex-direction: column; gap: 12px; align-items: center; margin-bottom: 15px; }
        .mode-btn { width: 100%; max-width: 350px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; background: white; cursor: pointer; transition: all 0.2s; text-align: left; }
        .mode-btn:hover { border-color: #667eea; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,0.2); }
        .mode-btn h3 { color: #333; margin-bottom: 4px; font-size: 16px; }
        .mode-btn p { color: #888; font-size: 12px; margin: 0; }
        .checklist-section { margin-top: 15px; }
        .checklist-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px; }
        .checklist-header h3 { color: #333; font-size: 16px; }
        .checklist-stats { color: #666; font-size: 13px; }
        .checklist-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 6px; max-height: 180px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 10px; padding: 12px; }
        .checklist-item { display: flex; align-items: center; gap: 6px; padding: 6px; background: #f8f9fa; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .checklist-item:hover { background: #e9ecef; }
        .checklist-item.checked { background: #d4edda; text-decoration: line-through; color: #888; }
        .checklist-item input { width: 14px; height: 14px; flex-shrink: 0; }
        .checklist-item span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .checklist-actions { margin-top: 12px; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
        .study-header { text-align: center; margin-bottom: 15px; }
        .mode-badge { display: inline-block; padding: 8px 16px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 20px; font-size: 14px; margin-bottom: 10px; font-weight: 600; }
        .study-counter { font-size: 16px; color: #4b5563; font-weight: 500; }
        .card { background: linear-gradient(135deg, #f8f9ff 0%, #e8edff 100%); border-radius: 15px; padding: 20px; margin-bottom: 15px; text-align: center; min-height: 150px; display: flex; flex-direction: column; justify-content: center; }
        .card-main { font-size: 28px; font-weight: bold; color: #111; margin-bottom: 10px; letter-spacing: 0.5px; word-break: break-word; }
        .card-main.meaning-mode { font-size: 20px; line-height: 1.5; color: #111; }
        .card-pron { font-size: 15px; color: #333; font-style: italic; margin-bottom: 12px; }
        .card-answer { font-size: 20px; color: #111; margin-bottom: 10px; padding: 12px; background: rgba(255,255,255,0.85); border-radius: 10px; font-weight: 500; word-break: break-word; }
        .card-syn { font-size: 13px; color: #444; margin-bottom: 10px; }
        .example-box { margin-top: 12px; padding: 12px; background: #fef3c7; border-radius: 10px; font-size: 13px; color: #111; border-left: 4px solid #f59e0b; text-align: left; line-height: 1.6; }
        .study-actions { display: flex; justify-content: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .nav-buttons { display: flex; justify-content: center; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
        .word-jump { text-align: center; margin-bottom: 15px; }
        .word-jump select { padding: 8px 12px; font-size: 13px; border: 2px solid #e0e0e0; border-radius: 8px; width: 100%; max-width: 250px; }
        .repeat-settings { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
        .repeat-settings label { color: #666; font-size: 13px; }
        .repeat-settings select, .repeat-settings input { padding: 6px 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 13px; width: 60px; }
        .repeat-status { text-align: center; color: #667eea; font-size: 13px; margin-bottom: 8px; min-height: 18px; }
        .sound-btns { display: flex; justify-content: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .sound-btn { padding: 8px 16px; font-size: 13px; border: 2px solid #667eea; border-radius: 20px; background: white; color: #667eea; cursor: pointer; transition: all 0.2s; }
        .sound-btn:hover, .sound-btn.active { background: #667eea; color: white; }
        .quiz-options { display: flex; flex-direction: column; gap: 10px; margin: 15px 0; }
        .quiz-option { padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 10px; background: white; cursor: pointer; transition: all 0.2s; text-align: left; font-size: 15px; color: #111; line-height: 1.4; word-break: break-word; }
        .quiz-option:hover { border-color: #667eea; background: #f8f9ff; }
        .quiz-option.selected { border-color: #667eea; background: #e8edff; }
        .quiz-option.correct { border-color: #10b981; background: #d1fae5; color: #065f46; font-weight: 600; }
        .quiz-option.wrong { border-color: #ef4444; background: #fee2e2; color: #991b1b; }
        .quiz-option.show-correct { border-color: #10b981; background: #d1fae5; }
        .quiz-option:disabled { cursor: not-allowed; }
        .quiz-result { text-align: center; padding: 12px; margin: 12px 0; border-radius: 10px; font-weight: bold; font-size: 15px; word-break: break-word; }
        .quiz-result.correct { background: #d1fae5; color: #065f46; }
        .quiz-result.wrong { background: #fee2e2; color: #991b1b; }
        .score-display { text-align: center; font-size: 17px; color: #4f46e5; margin-bottom: 15px; font-weight: 600; }
        
        @media (max-width: 480px) {
            .container { padding: 15px; border-radius: 15px; }
            .start-section h1 { font-size: 22px; }
            .card-main { font-size: 24px; }
            .card-main.meaning-mode { font-size: 18px; }
            .quiz-option { font-size: 14px; padding: 10px 14px; }
            .btn { padding: 10px 20px; font-size: 14px; }
            .mode-btn { padding: 12px; }
            .mode-btn h3 { font-size: 15px; }
            .checklist-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="start-section" class="start-section">
            <h1>ğŸ“š ì˜ì–´ ë‹¨ì–´ í•™ìŠµ</h1>
            <p>ë‹¨ì–´ì¥ì„ ì„ íƒí•˜ê³  í•™ìŠµì„ ì‹œì‘í•˜ì„¸ìš”!</p>
            <div class="wordlist-selector">
                <select id="wordlist-select" onchange="changeWordlist()">
                    <option value="list1">ğŸ“˜ ë‹¨ì–´ì¥ 1 (100ê°œ)</option>
                    <option value="list2">ğŸ“— ë‹¨ì–´ì¥ 2 (100ê°œ)</option>
                    <option value="list3">ğŸ“™ ë‹¨ì–´ì¥ 3 (100ê°œ)</option>
                    <option value="idioms1">ğŸ’¬ í† ìµ ìˆ™ì–´ì¥ 1 (100ê°œ)</option>
                    <option value="idioms2">ğŸ’¬ í† ìµ ìˆ™ì–´ì¥ 2 (100ê°œ)</option>
                    <option value="idioms3">ğŸ’¬ í† ìµ ìˆ™ì–´ì¥ 3 (100ê°œ)</option>
                </select>
            </div>
            <div class="mode-buttons">
                <div class="mode-btn" onclick="startStudy('word-to-meaning')"><h3>ğŸ”¤ ë‹¨ì–´ â†’ ëœ»</h3><p>ì˜ì–´ ë‹¨ì–´ë¥¼ ë³´ê³  ëœ»ì„ í•™ìŠµí•˜ì„¸ìš”</p></div>
                <div class="mode-btn" onclick="startStudy('meaning-to-word')"><h3>ğŸ“ ëœ» â†’ ë‹¨ì–´</h3><p>í•œê¸€ ëœ»ì„ ë³´ê³  ì˜ì–´ ë‹¨ì–´ë¥¼ í•™ìŠµí•˜ì„¸ìš”</p></div>
                <div class="mode-btn" onclick="startStudy('listen')"><h3>ğŸ§ ë‹¨ì–´ì¥ ë“£ê¸°</h3><p>ì „ì²´ ë‹¨ì–´ë¥¼ ë“¤ìœ¼ë©° í•™ìŠµí•˜ì„¸ìš”</p></div>
            </div>
            <div class="checklist-section">
                <div class="checklist-header"><h3>âœ… ì•„ëŠ” ë‹¨ì–´ ì²´í¬</h3><span class="checklist-stats" id="checklist-stats">0ê°œ ì²´í¬ë¨</span></div>
                <div class="checklist-grid" id="checklist-grid"></div>
                <div class="checklist-actions">
                    <button class="btn btn-small" onclick="selectAll()">ì „ì²´ ì„ íƒ</button>
                    <button class="btn btn-small btn-secondary" onclick="deselectAll()">ì „ì²´ í•´ì œ</button>
                </div>
            </div>
        </div>

        <div id="study-section" class="hidden">
            <div class="study-header">
                <div class="mode-badge" id="mode-badge">ë‹¨ì–´ â†’ ëœ»</div>
                <div class="study-counter"><span id="study-current">1</span> / <span id="study-total">50</span></div>
            </div>
            <div class="score-display">ì •ë‹µ: <span id="correct-count">0</span> / ì˜¤ë‹µ: <span id="wrong-count">0</span></div>
            <div class="card">
                <div class="card-main" id="card-main"></div>
                <div class="card-pron" id="card-pron"></div>
            </div>
            <div class="quiz-options" id="quiz-options"></div>
            <div class="quiz-result hidden" id="quiz-result"></div>
            <div class="example-box hidden" id="example-box"></div>
            <div class="study-actions">
                <button class="btn btn-small" onclick="speakCurrent()">ğŸ”Š ë°œìŒ ë“£ê¸°</button>
            </div>
            <div class="nav-buttons">
                <button class="btn" id="next-btn" onclick="nextCard()" disabled>ë‹¤ìŒ â–¶</button>
            </div>
            <button class="btn btn-secondary" onclick="goHome()">ğŸ  ë©”ì¸ìœ¼ë¡œ</button>
        </div>

        <div id="listen-section" class="hidden">
            <div class="study-header">
                <div class="mode-badge">ğŸ§ ë‹¨ì–´ì¥ ë“£ê¸°</div>
                <div class="study-counter"><span id="listen-current">1</span> / <span id="listen-total">50</span></div>
            </div>
            <div class="card">
                <div class="card-main" id="listen-word"></div>
                <div class="card-pron" id="listen-pron"></div>
                <div class="card-answer" id="listen-meaning"></div>
                <div class="card-syn" id="listen-syn"></div>
                <div class="example-box" id="listen-example"></div>
            </div>
            <div class="repeat-settings">
                <label>ë°˜ë³µ:</label>
                <select id="repeat-count"><option value="1">1íšŒ</option><option value="2">2íšŒ</option><option value="3" selected>3íšŒ</option><option value="5">5íšŒ</option></select>
                <label>ê°„ê²©(ì´ˆ):</label>
                <input type="number" id="repeat-interval" value="3" min="1" max="10">
            </div>
            <div class="repeat-status" id="repeat-status"></div>
            <div class="sound-btns">
                <button class="sound-btn" onclick="speakWord()">ğŸ”Š ë‹¨ì–´</button>
                <button class="sound-btn" onclick="speakMeaning()">ğŸ”Š ëœ»</button>
                <button class="sound-btn" onclick="speakBoth()">ğŸ”Š ì „ì²´</button>
                <button class="sound-btn" id="auto-btn" onclick="toggleAutoPlay()">ğŸ” ìë™ ì¬ìƒ</button>
                <button class="sound-btn" onclick="stopAutoPlay()">â¹ ì •ì§€</button>
            </div>
            <div class="nav-buttons">
                <button class="btn" onclick="prevListenCard()">â—€ ì´ì „</button>
                <button class="btn" onclick="reverseListenCards()">ğŸ”„ ìˆœì„œ ë’¤ì§‘ê¸°</button>
                <button class="btn" onclick="nextListenCard()">ë‹¤ìŒ â–¶</button>
            </div>
            <div class="word-jump">
                <select id="listen-jump-select" onchange="jumpToListenWord()"><option value="">ğŸ“– ë‹¨ì–´ ì„ íƒ...</option></select>
            </div>
            <button class="btn btn-secondary" onclick="goHome()">ğŸ  ë©”ì¸ìœ¼ë¡œ</button>
        </div>
    </div>

<script src="vocabulary_data.js"></script>
<script>
let currentWordlist = wordlist1;
let currentMode = '';
let currentIndex = 0;
let studyWords = [];
let checkedWords = new Set();
let isAutoPlaying = false;
let autoPlayTimer = null;
let repeatTimer = null;
let correctCount = 0;
let wrongCount = 0;
let answered = false;

document.addEventListener('DOMContentLoaded', () => { loadCheckedWords(); renderChecklist(); });

function changeWordlist() {
    const v = document.getElementById('wordlist-select').value;
    currentWordlist = v === 'list1' ? wordlist1 : v === 'list2' ? wordlist2 : v === 'list3' ? wordlist3 : v === 'idioms1' ? idioms1 : v === 'idioms2' ? idioms2 : idioms3;
    loadCheckedWords(); renderChecklist();
}

function renderChecklist() {
    const grid = document.getElementById('checklist-grid');
    grid.innerHTML = '';
    currentWordlist.forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = 'checklist-item' + (checkedWords.has(idx) ? ' checked' : '');
        div.innerHTML = `<input type="checkbox" ${checkedWords.has(idx) ? 'checked' : ''} onchange="toggleCheck(${idx})"><span>${item.word}</span>`;
        div.onclick = (e) => { if(e.target.tagName !== 'INPUT') toggleCheck(idx); };
        grid.appendChild(div);
    });
    document.getElementById('checklist-stats').textContent = `${checkedWords.size}ê°œ ì²´í¬ë¨`;
}

function toggleCheck(idx) { checkedWords.has(idx) ? checkedWords.delete(idx) : checkedWords.add(idx); saveCheckedWords(); renderChecklist(); }
function selectAll() { currentWordlist.forEach((_, idx) => checkedWords.add(idx)); saveCheckedWords(); renderChecklist(); }
function deselectAll() { checkedWords.clear(); saveCheckedWords(); renderChecklist(); }
function saveCheckedWords() { localStorage.setItem(document.getElementById('wordlist-select').value + '_checked', JSON.stringify([...checkedWords])); }
function loadCheckedWords() { const s = localStorage.getItem(document.getElementById('wordlist-select').value + '_checked'); checkedWords = s ? new Set(JSON.parse(s)) : new Set(); }

function startStudy(mode) {
    currentMode = mode;
    // ëª¨ë“  ëª¨ë“œì—ì„œ ì²´í¬ë˜ì§€ ì•Šì€ ë‹¨ì–´ë§Œ í¬í•¨
    studyWords = currentWordlist.filter((_, idx) => !checkedWords.has(idx));
    currentIndex = 0;
    correctCount = 0; wrongCount = 0; answered = false;
    if(mode === 'listen') { showSection('listen-section'); updateListenJumpSelect(); renderListenCard(); }
    else { showSection('study-section'); document.getElementById('mode-badge').textContent = mode === 'word-to-meaning' ? 'ğŸ”¤ ë‹¨ì–´ â†’ ëœ»' : 'ğŸ“ ëœ» â†’ ë‹¨ì–´'; renderQuizCard(); }
}

function showSection(id) { ['start-section', 'study-section', 'listen-section'].forEach(s => document.getElementById(s).classList.toggle('hidden', s !== id)); }
function goHome() { stopAutoPlay(); showSection('start-section'); }

function renderQuizCard() {
    answered = false;
    const w = studyWords[currentIndex], isWord = currentMode === 'word-to-meaning';
    document.getElementById('study-current').textContent = currentIndex + 1;
    document.getElementById('study-total').textContent = studyWords.length;
    document.getElementById('correct-count').textContent = correctCount;
    document.getElementById('wrong-count').textContent = wrongCount;
    const main = document.getElementById('card-main');
    main.textContent = isWord ? w.word : w.meaning;
    main.className = 'card-main' + (isWord ? '' : ' meaning-mode');
    document.getElementById('card-pron').textContent = isWord ? w.pron : '';
    document.getElementById('quiz-result').classList.add('hidden');
    document.getElementById('example-box').classList.add('hidden');
    document.getElementById('next-btn').disabled = true;
    
    // 4ì§€ì„ ë‹¤ ì˜µì…˜ ìƒì„±
    const options = generateOptions(currentIndex, isWord);
    const optionsDiv = document.getElementById('quiz-options');
    optionsDiv.innerHTML = options.map((opt, i) => 
        `<button class="quiz-option" onclick="checkAnswer(${i}, '${opt.replace(/'/g, "\\'")}', ${options.indexOf(isWord ? w.meaning : w.word)})">${i+1}. ${opt}</button>`
    ).join('');
}

function generateOptions(correctIdx, isWord) {
    const correct = studyWords[correctIdx];
    const correctAnswer = isWord ? correct.meaning : correct.word;
    const others = studyWords.filter((_, i) => i !== correctIdx);
    const shuffledOthers = shuffle([...others]).slice(0, 3);
    const wrongAnswers = shuffledOthers.map(w => isWord ? w.meaning : w.word);
    const allOptions = [correctAnswer, ...wrongAnswers];
    return shuffle(allOptions);
}

function checkAnswer(selectedIdx, selectedAnswer, correctIdx) {
    if(answered) return;
    answered = true;
    const w = studyWords[currentIndex];
    const isWord = currentMode === 'word-to-meaning';
    const correctAnswer = isWord ? w.meaning : w.word;
    const isCorrect = selectedAnswer === correctAnswer;
    
    const buttons = document.querySelectorAll('.quiz-option');
    buttons.forEach((btn, i) => {
        btn.disabled = true;
        const btnAnswer = btn.textContent.substring(3);
        if(btnAnswer === correctAnswer) btn.classList.add('correct');
        else if(i === selectedIdx && !isCorrect) btn.classList.add('wrong');
    });
    
    const result = document.getElementById('quiz-result');
    if(isCorrect) {
        correctCount++;
        result.textContent = 'âœ… ì •ë‹µì…ë‹ˆë‹¤!';
        result.className = 'quiz-result correct';
    } else {
        wrongCount++;
        result.textContent = `âŒ ì˜¤ë‹µ! ì •ë‹µ: ${correctAnswer}`;
        result.className = 'quiz-result wrong';
    }
    result.classList.remove('hidden');
    document.getElementById('correct-count').textContent = correctCount;
    document.getElementById('wrong-count').textContent = wrongCount;
    
    // ì˜ˆë¬¸ í‘œì‹œ
    const ex = document.getElementById('example-box');
    if(w.example) { ex.innerHTML = `<b>${w.example.eng}</b><br>${w.example.kor}`; ex.classList.remove('hidden'); }
    else if(w.tip) { ex.innerHTML = `ğŸ’¡ ${w.tip}`; ex.classList.remove('hidden'); }
    
    document.getElementById('next-btn').disabled = false;
    
    // 1.5ì´ˆ í›„ ìë™ìœ¼ë¡œ ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™
    setTimeout(() => {
        if(currentIndex < studyWords.length - 1) {
            nextCard();
        } else {
            showFinalResult();
        }
    }, 1500);
}

function speakCurrent() { speak(studyWords[currentIndex].word, 'en-US'); }
function nextCard() { 
    if(currentIndex < studyWords.length - 1) { currentIndex++; renderQuizCard(); }
    else { showFinalResult(); }
}

function showFinalResult() {
    const total = correctCount + wrongCount;
    const percent = Math.round((correctCount / total) * 100);
    document.getElementById('quiz-options').innerHTML = '';
    document.getElementById('card-main').textContent = 'ğŸ‰ í€´ì¦ˆ ì™„ë£Œ!';
    document.getElementById('card-pron').textContent = '';
    document.getElementById('quiz-result').innerHTML = `ì´ ${total}ë¬¸ì œ ì¤‘ ${correctCount}ê°œ ì •ë‹µ (${percent}%)`;
    document.getElementById('quiz-result').className = 'quiz-result correct';
    document.getElementById('quiz-result').classList.remove('hidden');
    document.getElementById('example-box').classList.add('hidden');
    document.getElementById('next-btn').disabled = true;
}

function renderListenCard() {
    const w = studyWords[currentIndex];
    document.getElementById('listen-current').textContent = currentIndex + 1;
    document.getElementById('listen-total').textContent = studyWords.length;
    document.getElementById('listen-word').textContent = w.word;
    document.getElementById('listen-pron').textContent = w.pron;
    document.getElementById('listen-meaning').textContent = w.meaning;
    document.getElementById('listen-syn').textContent = w.syn ? `ë™ì˜ì–´: ${w.syn}` : '';
    const ex = document.getElementById('listen-example');
    if(w.example) { ex.innerHTML = `<b>${w.example.eng}</b><br>${w.example.kor}`; ex.style.display = 'block'; }
    else if(w.tip) { ex.innerHTML = `ğŸ’¡ ${w.tip}`; ex.style.display = 'block'; }
    else { ex.style.display = 'none'; }
}

function prevListenCard() { 
    if(currentIndex > 0) { 
        const wasPlaying = isAutoPlaying;
        stopAutoPlay(); 
        currentIndex--; 
        renderListenCard(); 
        if(wasPlaying) setTimeout(() => toggleAutoPlay(), 100);
    } 
}
function nextListenCard() { 
    if(currentIndex < studyWords.length - 1) { 
        const wasPlaying = isAutoPlaying;
        stopAutoPlay(); 
        currentIndex++; 
        renderListenCard(); 
        if(wasPlaying) setTimeout(() => toggleAutoPlay(), 100);
    } 
}
function reverseListenCards() { 
    const wasPlaying = isAutoPlaying;
    stopAutoPlay(); 
    studyWords = studyWords.reverse(); 
    currentIndex = 0; 
    renderListenCard(); 
    updateListenJumpSelect(); 
    if(wasPlaying) setTimeout(() => toggleAutoPlay(), 100);
}
function updateListenJumpSelect() { const s = document.getElementById('listen-jump-select'); s.innerHTML = '<option value="">ğŸ“– ë‹¨ì–´ ì„ íƒ...</option>' + studyWords.map((w, i) => `<option value="${i}">${w.word}</option>`).join(''); }
function jumpToListenWord() { 
    const s = document.getElementById('listen-jump-select'); 
    if(s.value !== '') { 
        const wasPlaying = isAutoPlaying;
        stopAutoPlay(); 
        currentIndex = parseInt(s.value); 
        renderListenCard(); 
        s.value = ''; 
        if(wasPlaying) setTimeout(() => toggleAutoPlay(), 100);
    } 
}

let voices = [];
function loadVoices() { 
    voices = speechSynthesis.getVoices();
}
speechSynthesis.onvoiceschanged = loadVoices;
setTimeout(loadVoices, 100);
setTimeout(loadVoices, 500);

function getVoice(lang) {
    if(voices.length === 0) return null;
    if(lang === 'ko-KR') {
        return voices.find(x => x.name.includes('Google') && x.lang.includes('ko')) ||
               voices.find(x => x.lang.includes('ko'));
    } else {
        return voices.find(x => x.name.includes('Google') && x.lang.includes('en')) ||
               voices.find(x => x.lang.startsWith('en-US')) ||
               voices.find(x => x.lang.startsWith('en'));
    }
}

function speak(text, lang = 'en-US', onEnd = null) {
    speechSynthesis.cancel();
    
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang;
    u.rate = 0.9;
    u.pitch = 1.0;
    const v = getVoice(lang);
    if(v) u.voice = v;
    if(onEnd) {
        u.onend = onEnd;
        u.onerror = onEnd;
    }
    speechSynthesis.speak(u);
}

function speakWord() { speak(studyWords[currentIndex].word, 'en-US'); }
function speakMeaning() { speak(studyWords[currentIndex].meaning, 'ko-KR'); }

function speakBoth() {
    const w = studyWords[currentIndex], cnt = parseInt(document.getElementById('repeat-count').value), int = parseFloat(document.getElementById('repeat-interval').value) * 1000;
    let c = 0;
    function doSpeak() {
        if(c >= cnt) { document.getElementById('repeat-status').textContent = ''; return; }
        document.getElementById('repeat-status').textContent = `ë°˜ë³µ ${c + 1}/${cnt}`;
        speak(w.word, 'en-US', () => {
            repeatTimer = setTimeout(() => {
                speak(w.meaning, 'ko-KR', () => {
                    repeatTimer = setTimeout(() => { c++; doSpeak(); }, int + 500);
                });
            }, 800);
        });
    }
    doSpeak();
}

function toggleAutoPlay() {
    if(isAutoPlaying) { stopAutoPlay(); }
    else { isAutoPlaying = true; document.getElementById('auto-btn').classList.add('active'); autoPlayNext(); }
}

function autoPlayNext() {
    if(!isAutoPlaying) return;
    const w = studyWords[currentIndex], cnt = parseInt(document.getElementById('repeat-count').value), int = parseFloat(document.getElementById('repeat-interval').value) * 1000;
    let c = 0;
    function doSpeak() {
        if(!isAutoPlaying) return;
        if(c >= cnt) {
            if(currentIndex < studyWords.length - 1) { currentIndex++; renderListenCard(); autoPlayTimer = setTimeout(autoPlayNext, 1000); }
            else { stopAutoPlay(); }
            return;
        }
        document.getElementById('repeat-status').textContent = `${currentIndex + 1}ë²ˆì§¸ - ë°˜ë³µ ${c + 1}/${cnt}`;
        speak(w.word, 'en-US', () => {
            if(!isAutoPlaying) return;
            repeatTimer = setTimeout(() => {
                if(!isAutoPlaying) return;
                speak(w.meaning, 'ko-KR', () => {
                    if(!isAutoPlaying) return;
                    repeatTimer = setTimeout(() => { c++; doSpeak(); }, int + 500);
                });
            }, 800);
        });
    }
    doSpeak();
}

function stopAutoPlay() {
    isAutoPlaying = false;
    document.getElementById('auto-btn').classList.remove('active');
    document.getElementById('repeat-status').textContent = '';
    if(autoPlayTimer) clearTimeout(autoPlayTimer);
    if(repeatTimer) clearTimeout(repeatTimer);
    speechSynthesis.cancel();
}

function shuffle(arr) { for(let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }
</script>
</body>
</html>